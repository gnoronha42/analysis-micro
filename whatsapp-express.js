const express = require('express');
const fetch = require('node-fetch');
const router = express.Router();
const { EXPRESS_ACCOUNT_ANALYSIS, WHATSAPP_EXPRESS_PROMPT } = require('./analysis');

// Fun√ß√£o para processar dados e substituir placeholders
function processarDadosParaPrompt(dados) {
  console.log('üìä Processando dados para o prompt:', JSON.stringify(dados, null, 2));
  
  // Converter strings para n√∫meros
  const faturamento_30d = parseFloat(dados.faturamento30d?.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
  const visitantes = parseInt(dados.visitantes?.replace(/[^\d]/g, '')) || 0;
  const pedidos = parseInt(dados.pedidos?.replace(/[^\d]/g, '')) || 0;
  const invest_ads_mensal = parseFloat(dados.investimentoAds?.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
  const roas_mensal = parseFloat(dados.roasMensal?.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
  
  console.log('üî¢ Valores convertidos:', {
    faturamento_30d,
    visitantes,
    pedidos,
    invest_ads_mensal,
    roas_mensal
  });

  // C√°lculos conforme o prompt
  const conversao = visitantes > 0 ? ((pedidos / visitantes) * 100).toFixed(2) : '‚Äî';
  const ticket_medio = pedidos > 0 ? (faturamento_30d / pedidos).toFixed(2) : '‚Äî';
  const cpa_geral = pedidos > 0 ? (invest_ads_mensal / pedidos).toFixed(2) : '‚Äî';
  const roas_calculado = invest_ads_mensal > 0 ? (faturamento_30d / invest_ads_mensal).toFixed(2) : '‚Äî';
  
  // Normaliza√ß√µes
  const conv_norm = Math.min(100, Math.max(0, (parseFloat(conversao) / 3) * 100));
  const roas_norm = Math.min(100, Math.max(0, (parseFloat(roas_calculado) / 12) * 100));
  const trafego_norm = Math.min(100, Math.max(0, (visitantes / 10000) * 100));
  
  // Score de gargalo
  const score_gargalo = Math.round(0.4 * conv_norm + 0.4 * roas_norm + 0.2 * trafego_norm);
  
  // Dinheiro na mesa
  let dinheiro_na_mesa = 0;
  if (ticket_medio !== '‚Äî' && visitantes > 0) {
    const gmv_pot_conv2 = visitantes * 0.02 * parseFloat(ticket_medio);
    const gmv_pot_roas8 = invest_ads_mensal * 8;
    const potencial_bruto = Math.max(gmv_pot_conv2, gmv_pot_roas8);
    dinheiro_na_mesa = Math.max(0, potencial_bruto - faturamento_30d);
  }
  
  // Diagn√≥stico do gargalo
  let gargalo = 'Efici√™ncia (custo vs valor)';
  if (parseFloat(conversao) < 1.5) {
    gargalo = 'P√°gina/Oferta';
  } else if (parseFloat(roas_calculado) < 8 || (parseFloat(cpa_geral) >= 0.35 * parseFloat(ticket_medio))) {
    gargalo = 'Efici√™ncia (custo vs valor)';
  } else if (visitantes < 2000 && parseFloat(conversao) >= 1.5) {
    gargalo = 'Tr√°fego';
  }
  
  // Selos
  const selo_roas = parseFloat(roas_calculado) < 8 ? 'Abaixo da meta (8x)' : 
                   parseFloat(roas_calculado) <= 12 ? 'Na meta' : 'Acima da meta';
  const selo_conversao = parseFloat(conversao) < 1.5 ? 'Baixa' :
                        parseFloat(conversao) < 2 ? 'Aten√ß√£o' :
                        parseFloat(conversao) < 3 ? 'Intermedi√°ria' : 'Boa';
  const selo_trafego = visitantes < 2000 ? 'Baixo' :
                      visitantes <= 5000 ? 'Ok' : 'Alto';

  // Calcular proje√ß√µes (30 dias)
  let pedidos_realista = pedidos;
  let gmv_realista = faturamento_30d;
  let pedidos_otimista = pedidos;
  let gmv_otimista = faturamento_30d;
  
  if (ticket_medio !== '‚Äî' && visitantes > 0) {
    // Realista: +10% tr√°fego, +0,3% convers√£o
    const visitas_realista = Math.round(visitantes * 1.10);
    const conv_realista = Math.min(100, parseFloat(conversao) + 0.3);
    pedidos_realista = Math.round(visitas_realista * (conv_realista / 100));
    gmv_realista = pedidos_realista * parseFloat(ticket_medio);
    
    // Otimista: +20% tr√°fego, +0,6% convers√£o
    const visitas_otimista = Math.round(visitantes * 1.20);
    const conv_otimista = Math.min(100, parseFloat(conversao) + 0.6);
    pedidos_otimista = Math.round(visitas_otimista * (conv_otimista / 100));
    gmv_otimista = pedidos_otimista * parseFloat(ticket_medio);
  }

  console.log('üìà M√©tricas calculadas:', {
    conversao,
    ticket_medio,
    cpa_geral,
    roas_calculado,
    score_gargalo,
    dinheiro_na_mesa: dinheiro_na_mesa.toFixed(2),
    gargalo,
    selo_roas,
    selo_conversao,
    selo_trafego,
    pedidos_realista,
    pedidos_otimista
  });

  return {
    nome: dados.nome || 'Cliente',
    faturamento_30d: faturamento_30d.toLocaleString('pt-BR', {minimumFractionDigits: 2}),
    visitantes: visitantes.toLocaleString('pt-BR'),
    pedidos: pedidos.toString(),
    invest_ads_mensal: invest_ads_mensal.toLocaleString('pt-BR', {minimumFractionDigits: 2}),
    roas_mensal: roas_mensal.toFixed(2).replace('.', ','),
    maior_desafio: dados.desafio || 'N√£o informado',
    conversao,
    ticket_medio,
    cpa_geral,
    roas_calculado,
    score_gargalo,
    dinheiro_na_mesa: dinheiro_na_mesa.toLocaleString('pt-BR', {minimumFractionDigits: 2}),
    gargalo,
    selo_roas,
    selo_conversao,
    selo_trafego,
    // Proje√ß√µes
    pedidos_realista: pedidos_realista.toString(),
    gmv_realista: gmv_realista.toLocaleString('pt-BR', {minimumFractionDigits: 2}),
    delta_pedidos_realista: (pedidos_realista - pedidos).toString(),
    pedidos_otimista: pedidos_otimista.toString(),
    gmv_otimista: gmv_otimista.toLocaleString('pt-BR', {minimumFractionDigits: 2}),
    delta_pedidos_otimista: (pedidos_otimista - pedidos).toString()
  };
}

// Fun√ß√£o utilit√°ria para chamada √† OpenAI
async function gerarMensagemExpressOpenAI(dados) {
  console.log('ü§ñ Iniciando gera√ß√£o de an√°lise com IA...');
  
  // Processar dados e substituir placeholders
  const dadosProcessados = processarDadosParaPrompt(dados);
  
  // Substituir placeholders no prompt
  let promptFinal = WHATSAPP_EXPRESS_PROMPT
    .replace(/\{\{nome\}\}/g, dadosProcessados.nome)
    .replace(/\{\{faturamento_30d\}\}/g, dadosProcessados.faturamento_30d)
    .replace(/\{\{visitantes\}\}/g, dadosProcessados.visitantes)
    .replace(/\{\{pedidos\}\}/g, dadosProcessados.pedidos)
    .replace(/\{\{invest_ads_mensal\}\}/g, dadosProcessados.invest_ads_mensal)
    .replace(/\{\{roas_mensal\}\}/g, dadosProcessados.roas_mensal)
    .replace(/\{\{maior_desafio\}\}/g, dadosProcessados.maior_desafio)
    .replace(/\{\{Conversao\}\}/g, dadosProcessados.conversao)
    .replace(/\{\{Ticket_Medio\}\}/g, dadosProcessados.ticket_medio)
    .replace(/\{\{CPA_Geral\}\}/g, dadosProcessados.cpa_geral)
    .replace(/\{\{ROAS_Calculado\}\}/g, dadosProcessados.roas_calculado)
    .replace(/\{\{Score_Gargalo\}\}/g, dadosProcessados.score_gargalo)
    .replace(/\{\{Dinheiro_na_Mesa\}\}/g, dadosProcessados.dinheiro_na_mesa)
    .replace(/\{\{Gargalo\}\}/g, dadosProcessados.gargalo)
    .replace(/\{\{Selo_ROAS\}\}/g, dadosProcessados.selo_roas)
    .replace(/\{\{Selo_Conversao\}\}/g, dadosProcessados.selo_conversao)
    .replace(/\{\{Selo_Trafego\}\}/g, dadosProcessados.selo_trafego);

  console.log('üìù Prompt final preparado (primeiros 500 chars):', promptFinal.substring(0, 500));

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
    },
    body: JSON.stringify({
      model: "gpt-4o",
      messages: [
        { 
          role: "system", 
          content: `Voc√™ √© um consultor s√™nior de Shopee Ads do EFEITO VENDAS. 

INSTRU√á√ïES ESPEC√çFICAS:
1. Use EXATAMENTE os dados fornecidos - NUNCA invente valores
2. Gere apenas a "SA√çDA 2 - MINI-RELAT√ìRIO" do prompt
3. Fa√ßa TODOS os c√°lculos conforme as regras definidas no prompt
4. Use os selos e classifica√ß√µes exatas conforme o prompt
5. Seja t√©cnico, objetivo e focado em convers√£o para assinatura
6. N√ÉO gere as mensagens de WhatsApp, apenas o mini-relat√≥rio

IMPORTANTE: Execute todos os c√°lculos matem√°ticos conforme especificado no prompt antes de gerar o relat√≥rio.` 
        },
        { role: "user", content: promptFinal },
      ],
      max_tokens: 2500,
      temperature: 0.1,
    }),
  });

  if (!response.ok) {
    const errorData = await response.json();
    console.error('‚ùå Erro da OpenAI:', errorData);
    throw new Error(`Erro ao gerar an√°lise com OpenAI: ${errorData.error?.message || 'Erro desconhecido'}`);
  }
  
  const data = await response.json();
  console.log('‚úÖ An√°lise gerada com sucesso');
  return data.choices?.[0]?.message?.content || "An√°lise n√£o gerada.";
}

// Fun√ß√£o para validar e formatar n√∫mero de telefone
function formatarNumeroTelefone(numero) {
  // Remove todos os caracteres n√£o num√©ricos
  const numeroLimpo = numero.replace(/\D/g, '');
  
  // Se n√£o come√ßar com 55, adiciona (c√≥digo do Brasil)
  if (!numeroLimpo.startsWith('55')) {
    return '55' + numeroLimpo;
  }
  
  return numeroLimpo;
}

// Fun√ß√£o para formatar mensagem bonita para WhatsApp baseada na an√°lise da IA
function formatarMensagemWhatsAppComAnalise(dadosProcessados, analiseIA) {
  // Extrair informa√ß√µes espec√≠ficas da an√°lise da IA se poss√≠vel
  let gargaloIA = dadosProcessados.gargalo;
  let dinheiroMesaIA = dadosProcessados.dinheiro_na_mesa;
  
  // Tentar extrair informa√ß√µes mais espec√≠ficas da an√°lise da IA
  if (analiseIA && analiseIA.includes('Gargalo Principal')) {
    const gargaloMatch = analiseIA.match(/Gargalo Principal[:\s]*([^‚Ä¢\n]+)/i);
    if (gargaloMatch && gargaloMatch[1]) {
      gargaloIA = gargaloMatch[1].trim().replace(/[‚Ä¢\-]/g, '').trim();
    }
  }
  
  if (analiseIA && analiseIA.includes('Dinheiro na Mesa')) {
    const dinheiroMatch = analiseIA.match(/R\$\s*([\d.,]+)/);
    if (dinheiroMatch && dinheiroMatch[1]) {
      dinheiroMesaIA = dinheiroMatch[1];
    }
  }

  const mensagem = `
üöÄ *AN√ÅLISE EXPRESS EFEITO VENDAS* üöÄ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üëã Ol√° *${dadosProcessados.nome}*!

Sua an√°lise personalizada est√° pronta! üìä

üìà *VIS√ÉO GERAL (30 DIAS)*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ *Faturamento:* R$ ${dadosProcessados.faturamento_30d}
üì¶ *Pedidos:* ${dadosProcessados.pedidos}
üë• *Visitantes:* ${dadosProcessados.visitantes}
üí∏ *Investimento Ads:* R$ ${dadosProcessados.invest_ads_mensal}

üéØ *M√âTRICAS PRINCIPAIS*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä *ROAS Informado:* ${dadosProcessados.roas_mensal}x
üìà *ROAS Calculado:* ${dadosProcessados.roas_calculado}x [${dadosProcessados.selo_roas}]
üîÑ *Taxa Convers√£o:* ${dadosProcessados.conversao}% [${dadosProcessados.selo_conversao}]
üíµ *Ticket M√©dio:* R$ ${dadosProcessados.ticket_medio}
üéØ *CPA:* R$ ${dadosProcessados.cpa_geral}
‚ö° *Score Gargalo:* ${dadosProcessados.score_gargalo}/100

üîç *DIAGN√ìSTICO PRINCIPAL*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üö® *Gargalo Identificado:* ${gargaloIA}
üéØ *Relacionado ao seu desafio:* "${dadosProcessados.maior_desafio}"

üíé *DINHEIRO NA MESA*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ Voc√™ pode estar deixando de capturar:
*R$ ${dinheiroMesaIA}* este m√™s! ü§Ø

üìä *PROJE√á√ïES 30 DIAS*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üü¢ *Conservador:* ${dadosProcessados.pedidos} pedidos | R$ ${dadosProcessados.faturamento_30d}
üü° *Realista:* ${dadosProcessados.pedidos_realista} pedidos (+${dadosProcessados.delta_pedidos_realista}) | R$ ${dadosProcessados.gmv_realista}
üü† *Otimista:* ${dadosProcessados.pedidos_otimista} pedidos (+${dadosProcessados.delta_pedidos_otimista}) | R$ ${dadosProcessados.gmv_otimista}

üîí *O QUE VOC√ä N√ÉO EST√Å VENDO*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîê Top 5 SKUs por potencial (CTR, CPC, ROAS)
üîê Mapa de Funil por SKU detalhado
üîê Proje√ß√µes semanais & metas por campanha
üîê Prioriza√ß√£o de verba autom√°tica

‚ö° *POR QUE ASSINAR AGORA?*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ Dossi√™ pr√°tico, pronto para decis√£o
‚úÖ Atualizado todo m√™s automaticamente
‚úÖ Foco em margem e escalabilidade
‚úÖ Se j√° est√° na meta, pr√≥ximo passo √© *ESCALA COM CONTROLE*

üéØ *PR√ìXIMOS PASSOS*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üî• *Assinar Relat√≥rio Completo Efeito Vendas*
üìä *Ver Amostra de 1 SKU*

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí¨ *Responda esta mensagem para saber mais!*
üöÄ *EFEITO VENDAS - Especialistas em Shopee*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

  return mensagem.trim();
}

// Fun√ß√£o para truncar mensagem se necess√°rio
function truncarMensagem(mensagem, maxLength = 4000) {
  if (mensagem.length <= maxLength) {
    return mensagem;
  }
  
  // Trunca e adiciona indica√ß√£o de continua√ß√£o
  const truncated = mensagem.substring(0, maxLength - 200);
  return truncated + '\n\n...\n\nüìû *Continue a conversa conosco para receber a an√°lise completa!*\nüöÄ *EFEITO VENDAS*';
}

// Fun√ß√£o para enviar mensagem de texto via BotConversa
async function enviarMensagemParaWhatsapp(numero, mensagem, nome = '') {
  console.log('üì± Iniciando envio de mensagem para WhatsApp...');
  
  // Formatar n√∫mero de telefone
  const numeroFormatado = formatarNumeroTelefone(numero);
  console.log('üìû N√∫mero original:', numero);
  console.log('üìû N√∫mero formatado:', numeroFormatado);
  console.log('üë§ Nome:', nome);
  
  // Validar mensagem
  if (!mensagem || typeof mensagem !== 'string' || mensagem.trim().length === 0) {
    throw new Error('Mensagem inv√°lida ou vazia');
  }
  
  // Truncar mensagem se necess√°rio
  const mensagemFinal = truncarMensagem(mensagem);
  console.log('üìù Tamanho da mensagem original:', mensagem.length, 'caracteres');
  console.log('üìù Tamanho da mensagem final:', mensagemFinal.length, 'caracteres');

  const BOTCONVERSA_TOKEN = process.env.BOTCONVERSA_TOKEN;
  
  if (!BOTCONVERSA_TOKEN) {
    throw new Error('BOTCONVERSA_TOKEN n√£o configurado nas vari√°veis de ambiente');
  }
  
  const [first_name, ...rest] = (nome || '').split(' ');
  const last_name = rest.join(' ') || 'Cliente';

  try {
    // 1. Cadastrar subscriber
    console.log('üë§ Cadastrando subscriber...');
    
    const subscriberPayload = {
      phone: numeroFormatado,
      first_name: first_name || 'Cliente',
      last_name: last_name
    };
    
    console.log('üì§ Payload do subscriber:', JSON.stringify(subscriberPayload, null, 2));
    
    const subscriberRes = await fetch('https://backend.botconversa.com.br/api/v1/webhook/subscriber/', {
      method: 'POST',
      headers: {
        'API-KEY': BOTCONVERSA_TOKEN,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(subscriberPayload)
    });

    if (!subscriberRes.ok) {
      const errorText = await subscriberRes.text();
      console.error('‚ùå Erro ao criar subscriber:', errorText);
      console.error('‚ùå Status do subscriber:', subscriberRes.status);
      throw new Error(`Erro ao criar subscriber: ${errorText}`);
    }
    
    const subscriberData = await subscriberRes.json();
    console.log('‚úÖ Resposta do subscriber:', JSON.stringify(subscriberData, null, 2));
    
    const subscriberId = subscriberData.id;
    if (!subscriberId) {
      console.error('‚ùå ID do subscriber n√£o retornado:', subscriberData);
      throw new Error('ID do subscriber n√£o foi retornado pela API');
    }
    
    console.log('‚úÖ Subscriber criado com ID:', subscriberId);

    // 2. Enviar mensagem de texto
    console.log('üí¨ Enviando mensagem de texto...');
    
    // Limpar mensagem de caracteres problem√°ticos
    const mensagemLimpa = mensagemFinal
      .replace(/[^\w\s\-.,!?@#$%&*()+=\[\]{};:'"<>\/\\|`~√°√©√≠√≥√∫√†√®√¨√≤√π√¢√™√Æ√¥√ª√£√µ√ß√Å√â√ç√ì√ö√Ä√à√å√í√ô√Ç√ä√é√î√õ√É√ï√á]/g, '') // Remove caracteres especiais
      .trim();
    
    console.log('üìù Mensagem original (100 chars):', mensagemFinal.substring(0, 100));
    console.log('üìù Mensagem limpa (100 chars):', mensagemLimpa.substring(0, 100));
    
    // Primeiro tentar com mensagem de teste simples
    const mensagemTeste = 'Ol√°! Esta √© uma mensagem de teste.';
    
    // Formato correto baseado na documenta√ß√£o da API
    const messagePayload = {
      type: 'text',
      value: mensagemLimpa
    };
    
    console.log('üì§ Payload correto da mensagem:', JSON.stringify(messagePayload, null, 2));
    
    const messageRes = await fetch(`https://backend.botconversa.com.br/api/v1/webhook/subscriber/${subscriberId}/send_message/`, {
      method: 'POST',
      headers: {
        'API-KEY': BOTCONVERSA_TOKEN,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(messagePayload)
    });

    if (!messageRes.ok) {
      const errorText = await messageRes.text();
      console.error('‚ùå Erro ao enviar mensagem:', errorText);
      console.error('‚ùå Status:', messageRes.status);
      console.error('‚ùå Headers:', Object.fromEntries(messageRes.headers.entries()));
      throw new Error(`Erro ao enviar mensagem: ${errorText}`);
    }
    
    const messageData = await messageRes.json();
    console.log('‚úÖ Mensagem enviada com sucesso!');
    console.log('‚úÖ Resposta da API:', JSON.stringify(messageData, null, 2));
    return messageData;

  } catch (error) {
    console.error('‚ùå Erro no processo de envio:', error);
    throw error;
  }
}

router.post('/whatsapp-express', async (req, res) => {
  try {
    console.log('üöÄ Iniciando processamento da an√°lise express...');
    console.log('üìä Dados recebidos:', JSON.stringify(req.body, null, 2));

    const { nome, email, telefone, faturamento30d, visitantes, pedidos, investimentoAds, roasMensal, desafio } = req.body;
    
    // Valida√ß√µes
    if (!telefone) {
      console.log('‚ùå Telefone n√£o fornecido');
      return res.status(400).json({ error: "Telefone √© obrigat√≥rio para envio ao WhatsApp." });
    }

    if (!nome || !faturamento30d || !visitantes || !pedidos || !investimentoAds || !roasMensal || !desafio) {
      console.log('‚ùå Dados obrigat√≥rios faltando');
      return res.status(400).json({ error: "Todos os campos s√£o obrigat√≥rios: nome, faturamento30d, visitantes, pedidos, investimentoAds, roasMensal, desafio." });
    }
    
    console.log('‚úÖ Valida√ß√µes passaram, gerando an√°lise com IA...');
    
    // Gerar an√°lise usando OpenAI com o prompt completo
    const analiseIA = await gerarMensagemExpressOpenAI({ nome, email, faturamento30d, visitantes, pedidos, investimentoAds, roasMensal, desafio });
    
    console.log('ü§ñ An√°lise da IA gerada (primeiros 300 chars):', analiseIA.substring(0, 300));
    
    // Processar dados para formata√ß√£o bonita do WhatsApp
    const dadosProcessados = processarDadosParaPrompt({ nome, email, faturamento30d, visitantes, pedidos, investimentoAds, roasMensal, desafio });
    
    // Formatar mensagem bonita para WhatsApp baseada na an√°lise da IA
    const analise = formatarMensagemWhatsAppComAnalise(dadosProcessados, analiseIA);
    
    console.log('üìù Mensagem final formatada (primeiros 300 chars):', analise.substring(0, 300));
    
    // Envia a mensagem de texto para o WhatsApp
    const resultado = await enviarMensagemParaWhatsapp(telefone, analise, nome);
    
    console.log('‚úÖ Processo conclu√≠do com sucesso!');
    return res.json({ 
      success: true, 
      mensagem: 'An√°lise enviada com sucesso para o WhatsApp!', 
      resultado,
      preview: analise.substring(0, 200) + '...'
    });
  } catch (error) {
    console.error('‚ùå Erro no processamento:', error);
    return res.status(500).json({ 
      error: error.message || "Erro interno do servidor",
      details: "Falha no processamento da an√°lise express"
    });
  }
});

module.exports = router;
